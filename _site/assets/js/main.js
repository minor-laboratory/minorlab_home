// MinorLab ÌôàÌéòÏù¥ÏßÄ Î©îÏù∏ JavaScript
class MinorLabSite {
  constructor() {
    this.SUPABASE_URL = 'https://rfgljhekqxphguooidjj.supabase.co';
    this.SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJmZ2xqaGVrcXhwaGd1b29pZGpqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzY1Njc0NjEsImV4cCI6MjA1MjE0MzQ2MX0.UdPVYMMF4vk8_rX634AzyWiSt4CYa05n3cPNaEPqt4I';

    this.init();
  }

  init() {
    console.log('MinorLabSite initializing...');
    this.setupThemeToggle();
    this.setupLanguageDropdown();
    // Ïï± Î°úÎî©ÏùÑ Îçî ÏïàÏ†ïÏ†ÅÏúºÎ°ú Ï≤òÎ¶¨
    this.loadFamilyAppsWithRetry();
    this.setupSmoothScrolling();
    this.setupAnimations();
    this.setupAccountDeletion();
  }

  // Ïû¨ÏãúÎèÑÍ∞Ä Ìè¨Ìï®Îêú Ïï± Î°úÎî©
  loadFamilyAppsWithRetry() {
    console.log('=== loadFamilyAppsWithRetry started ===');

    // Ï¶âÏãú Í∏∞Î≥∏ Ïï± ÌëúÏãú (ÌÖåÏä§Ìä∏Ïö©)
    console.log('Showing default apps immediately for testing');
    this.showDefaultApps();

    // ÎèôÏãúÏóê API Ìò∏Ï∂úÎèÑ ÏãúÎèÑ
    this.loadFamilyApps();

    // 1Ï¥à ÌõÑ Ïû¨ÏãúÎèÑ (API Ïã§Ìå® ÏãúÎ•º ÏúÑÌï¥)
    setTimeout(() => {
      const appsContent = document.getElementById('apps-content');
      if (appsContent && appsContent.classList.contains('hidden')) {
        console.log('Apps still hidden, retrying...');
        this.loadFamilyApps();
      }
    }, 1000);

    // 3Ï¥à ÌõÑ ÎßàÏßÄÎßâ ÏãúÎèÑ (Í∞ïÏ†ú ÌëúÏãú)
    setTimeout(() => {
      const appsContent = document.getElementById('apps-content');
      if (appsContent && appsContent.classList.contains('hidden')) {
        console.log('Force showing default apps after 3 seconds');
        this.showDefaultApps();
      }
    }, 3000);
  }

  // ÌÖåÎßà ÌÜ†Í∏Ä ÏÑ§Ï†ï
  setupThemeToggle() {
    const themeToggle = document.getElementById('themeToggle');
    const themeIcon = themeToggle?.querySelector('.theme-icon');

    if (!themeToggle) return;

    // Ï†ÄÏû•Îêú ÌÖåÎßà Î°úÎìú
    const savedTheme = localStorage.getItem('theme');
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const currentTheme = savedTheme || (prefersDark ? 'dark' : 'light');

    this.setTheme(currentTheme);

    // ÌÖåÎßà ÌÜ†Í∏Ä Ïù¥Î≤§Ìä∏
    themeToggle.addEventListener('click', () => {
      const isCurrentlyDark = document.documentElement.getAttribute('data-theme') === 'dark';
      const newTheme = isCurrentlyDark ? 'light' : 'dark';
      this.setTheme(newTheme);
      localStorage.setItem('theme', newTheme);
    });
  }

  setTheme(theme) {
    document.documentElement.setAttribute('data-theme', theme);
    const themeIcon = document.querySelector('.theme-icon');
    if (themeIcon) {
      themeIcon.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
    }
  }

  // Ïñ∏Ïñ¥ ÎìúÎ°≠Îã§Ïö¥ ÏÑ§Ï†ï
  setupLanguageDropdown() {
    const langSelector = document.getElementById('langSelector');
    const langToggle = document.getElementById('langToggle');
    const langDropdown = document.getElementById('langDropdown');

    if (!langSelector || !langToggle || !langDropdown) return;

    // Ï†ÄÏû•Îêú Ïñ∏Ïñ¥ Í∏∞Î≥∏ÏÑ§Ï†ï ÌôïÏù∏ Î∞è Î¶¨ÎîîÎ†âÏÖò
    this.checkSavedLanguagePreference();

    // ÎìúÎ°≠Îã§Ïö¥ ÌÜ†Í∏Ä
    langToggle.addEventListener('click', (e) => {
      e.stopPropagation();
      langSelector.classList.toggle('open');
    });

    // Ïô∏Î∂Ä ÌÅ¥Î¶≠ Ïãú ÎìúÎ°≠Îã§Ïö¥ Îã´Í∏∞
    document.addEventListener('click', (e) => {
      if (!langSelector.contains(e.target)) {
        langSelector.classList.remove('open');
      }
    });

    // Ïñ∏Ïñ¥ ÏòµÏÖò ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ ÏÑ§Ï†ï
    const langOptions = langDropdown.querySelectorAll('.lang-option');
    langOptions.forEach(option => {
      option.addEventListener('click', (e) => {
        e.preventDefault();
        const selectedLang = option.getAttribute('data-lang');
        const targetUrl = option.getAttribute('href');

        // Ïñ∏Ïñ¥ ÏÑ†ÌÉù Ï†ÄÏû•
        localStorage.setItem('preferredLanguage', selectedLang);

        // ÌéòÏù¥ÏßÄ Ïù¥Îèô
        window.location.href = targetUrl;

        // ÎìúÎ°≠Îã§Ïö¥ Îã´Í∏∞
        langSelector.classList.remove('open');
      });
    });

    // ESC ÌÇ§Î°ú ÎìúÎ°≠Îã§Ïö¥ Îã´Í∏∞
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        langSelector.classList.remove('open');
      }
    });
  }

  // Ï†ÄÏû•Îêú Ïñ∏Ïñ¥ Í∏∞Î≥∏ÏÑ§Ï†ï ÌôïÏù∏
  checkSavedLanguagePreference() {
    const savedLang = localStorage.getItem('preferredLanguage');
    const currentLang = document.documentElement.lang || 'ko';

    // Ï†ÄÏû•Îêú Ïñ∏Ïñ¥Í∞Ä ÏûàÍ≥† ÌòÑÏû¨ Ïñ∏Ïñ¥ÏôÄ Îã§Î•¥Î©¥ Î¶¨ÎîîÎ†âÏÖò
    if (savedLang && savedLang !== currentLang) {
      const currentPath = window.location.pathname;
      let targetPath = '';

      if (savedLang === 'ko') {
        // ÌïúÍµ≠Ïñ¥Î°ú Ï†ÑÌôò - /en Ï†úÍ±∞
        if (currentPath.startsWith('/en')) {
          targetPath = currentPath.replace('/en', '') || '/';
        }
      } else if (savedLang === 'en') {
        // ÏòÅÏñ¥Î°ú Ï†ÑÌôò - /en Ï∂îÍ∞Ä
        if (!currentPath.startsWith('/en')) {
          targetPath = '/en' + currentPath;
        }
      }

      // Î¶¨ÎîîÎ†âÏÖò ÌïÑÏöîÌïú Í≤ΩÏö∞
      if (targetPath && targetPath !== currentPath) {
        console.log(`Ïñ∏Ïñ¥ Í∏∞Î≥∏ÏÑ§Ï†ï Î≥µÏõê: ${currentLang} ‚Üí ${savedLang}, ${currentPath} ‚Üí ${targetPath}`);
        window.location.replace(targetPath);
        return true;
      }
    }

    // ÌòÑÏû¨ Ïñ∏Ïñ¥Î•º Í∏∞Î≥∏ÏÑ§Ï†ïÏúºÎ°ú Ï†ÄÏû• (Ï≤´ Î∞©Î¨∏ Ïãú)
    if (!savedLang) {
      localStorage.setItem('preferredLanguage', currentLang);
    }

    return false;
  }

  // Supabase API Ìò∏Ï∂ú Ìó¨Ìçº
  async apiCall(endpoint, options = {}) {
    const url = `${this.SUPABASE_URL}/rest/v1${endpoint}`;
    const headers = {
      'apikey': this.SUPABASE_ANON_KEY,
      'Authorization': `Bearer ${this.SUPABASE_ANON_KEY}`,
      'Content-Type': 'application/json',
      ...options.headers
    };

    try {
      const response = await fetch(url, { ...options, headers });
      if (!response.ok) {
        throw new Error(`API call failed: ${response.status}`);
      }
      return await response.json();
    } catch (error) {
      console.error('API call error:', error);
      throw error;
    }
  }

  // Ìå®Î∞ÄÎ¶¨ Ïï± Î°úÎìú
  async loadFamilyApps() {
    console.log('Starting to load family apps...');
    try {
      const apps = await this.apiCall('/family_apps?is_active=eq.true&order=sort_order.asc');
      console.log('Loaded apps:', apps);

      if (apps && apps.length > 0) {
        console.log('Rendering apps for language:', document.documentElement.lang);
        console.log('About to call renderApps with apps:', apps);

        try {
          this.renderApps(apps);
          console.log('renderApps call completed successfully');
        } catch (renderError) {
          console.error('Error calling renderApps:', renderError);
          console.error('Render error stack:', renderError.stack);
          // Ïò§Î•ò Î∞úÏÉù Ïãú Í∏∞Î≥∏ Ïï± ÌëúÏãú
          this.showDefaultApps();
          return;
        }

        const loadingEl = document.getElementById('apps-loading');
        const contentEl = document.getElementById('apps-content');

        console.log('Before hiding loading - loading element:', loadingEl);
        console.log('Before showing content - content element:', contentEl);
        console.log('Content element classes before:', contentEl ? contentEl.className : 'null');

        if (loadingEl) loadingEl.classList.add('hidden');
        if (contentEl) contentEl.classList.remove('hidden');

        console.log('Content element classes after:', contentEl ? contentEl.className : 'null');
        console.log('Apps rendered successfully and visibility toggled');
      } else {
        throw new Error('No apps found');
      }
    } catch (error) {
      console.error('Failed to load family apps:', error);
      console.error('Error details:', error.message, error.stack);

      // ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•òÏù∏ Í≤ΩÏö∞ Í∏∞Î≥∏ Ïï± Ï†ïÎ≥¥ ÌëúÏãú
      if (error.message.includes('Failed to fetch') || error.message.includes('Network')) {
        console.log('Network error detected, showing default apps');
        this.showDefaultApps();
      } else {
        document.getElementById('apps-loading').classList.add('hidden');
        document.getElementById('apps-error').classList.remove('hidden');
      }
    }
  }

  // Ïï± Î™©Î°ù Î†åÎçîÎßÅ
  renderApps(apps) {
    try {
      console.log('renderApps called with:', apps);
      const appsContainer = document.getElementById('apps-content');
      const currentLang = document.documentElement.lang || 'ko';

      console.log('Apps container:', appsContainer);
      console.log('Current language:', currentLang);

      if (!appsContainer) {
        console.error('Apps container not found!');
        return;
      }

      console.log('Starting to generate HTML for each app...');
      const html = apps.map((app, index) => {
        console.log(`Processing app ${index + 1}:`, app.name);
        return this.createAppCard(app, currentLang);
      }).join('');

      console.log('Generated HTML length:', html.length);
      console.log('Generated HTML preview:', html.substring(0, 200) + '...');

      appsContainer.innerHTML = html;
      console.log('HTML set successfully');
      console.log('Container content length:', appsContainer.innerHTML.length);
    } catch (error) {
      console.error('Error in renderApps:', error);
      console.error('Error stack:', error.stack);
    }
  }

  // Ïï± Ïπ¥Îìú ÏÉùÏÑ±
  createAppCard(app, lang = 'ko') {
    console.log('Creating app card for:', app.name, 'in language:', lang);

    const statusClass = this.getStatusClass(app);
    const statusText = this.getStatusText(app, lang);
    const appIcon = this.getAppIcon(app);
    const appDescription = this.getAppDescription(app, lang);

    console.log('Card details:', { statusClass, statusText, appIcon, appDescription });

    const cardHtml = `
      <div class="app-card fade-in">
        <div class="app-icon">${appIcon}</div>
        <h3>${app.name}</h3>
        <p>${appDescription}</p>
        <div class="app-status">
          <span class="status-badge ${statusClass}">${statusText}</span>
        </div>
        ${this.createAppLinks(app)}
      </div>
    `;

    console.log('Generated card HTML:', cardHtml);
    return cardHtml;
  }

  // Ïï± ÏÑ§Î™Ö Í∞ÄÏ†∏Ïò§Í∏∞
  getAppDescription(app, lang = 'ko') {
    console.log('getAppDescription called with app:', app.name, 'lang:', lang);

    if (app.description) {
      console.log('Using app.description:', app.description);
      return app.description;
    }

    // Í∏∞Î≥∏ ÏÑ§Î™Ö - Îçî Í∞ÑÎã®Ìïú Î°úÏßÅ
    if (lang === 'en') {
      if (app.name === 'Î∂ÅÎû©' || app.target === 'books') {
        return 'Smart app for reading management and tracking';
      } else if (app.name === 'Î£®Ìã∞' || app.target === 'rooty') {
        return 'Healthy living through habit improvement';
      }
    } else {
      // ÌïúÍµ≠Ïñ¥ Í∏∞Î≥∏Í∞í
      if (app.name === 'Î∂ÅÎû©' || app.target === 'books') {
        return 'ÎèÖÏÑú Í¥ÄÎ¶¨ÏôÄ Í∏∞Î°ùÏùÑ ÏúÑÌïú Ïä§ÎßàÌä∏Ìïú Ïï±';
      } else if (app.name === 'Î£®Ìã∞' || app.target === 'rooty') {
        return 'ÏÉùÌôú ÏäµÍ¥Ä Í∞úÏÑ†ÏúºÎ°ú Í±¥Í∞ïÌïòÍ≤å';
      }
    }

    console.log('Using fallback description for:', app.name);
    return lang === 'en' ? 'Innovative app service' : 'ÌòÅÏã†Ï†ÅÏù∏ Ïï± ÏÑúÎπÑÏä§';
  }

  // Ïï± ÏïÑÏù¥ÏΩò Í≤∞Ï†ï
  getAppIcon(app) {
    if (app.icon_url) {
      return `<img src="${app.icon_url}" alt="${app.name}" class="app-icon-img">`;
    }

    // Í∏∞Î≥∏ ÏïÑÏù¥ÏΩò (Ïï± Ïù¥Î¶Ñ Í∏∞Î∞ò)
    const iconMap = {
      'Î∂ÅÎû©': 'üìö',
      'booklab': 'üìö',
      'Î£®Ìã∞': 'üéØ',
      'routine': 'üéØ',
      'ÎìúÎ¶ºÌÖîÎü¨': 'üí≠',
      'dreamteller': 'üí≠'
    };

    const appName = app.name.toLowerCase();
    return iconMap[appName] || iconMap[app.target] || 'üì±';
  }

  // ÏÉÅÌÉú ÌÅ¥ÎûòÏä§ Í≤∞Ï†ï
  getStatusClass(app) {
    if (app.ios_url || app.android_url || app.web_url) {
      return 'status-live';
    } else if (app.target === 'rooty' || app.name.includes('Î£®Ìã∞')) {
      return 'status-upcoming';
    } else if (app.target === 'books' || app.name.includes('Î∂ÅÎû©')) {
      return 'status-upcoming'; // Î∂ÅÎû©ÏùÄ Ï∂úÏãú ÏòàÏ†ïÏúºÎ°ú Î≥ÄÍ≤Ω
    } else {
      return 'status-planning';
    }
  }

  // ÏÉÅÌÉú ÌÖçÏä§Ìä∏ Í≤∞Ï†ï
  getStatusText(app, lang) {
    const statusClass = this.getStatusClass(app);

    const statusTexts = {
      ko: {
        'status-live': 'ÏÑúÎπÑÏä§ Ï§ë',
        'status-upcoming': 'Ï∂úÏãú ÏòàÏ†ï',
        'status-planning': 'Í∏∞Ìöç Ï§ë'
      },
      en: {
        'status-live': 'Live',
        'status-upcoming': 'Coming Soon',
        'status-planning': 'In Planning'
      }
    };

    return statusTexts[lang][statusClass] || statusTexts.ko[statusClass];
  }

  // Ïï± ÎßÅÌÅ¨ ÏÉùÏÑ±
  createAppLinks(app) {
    const links = [];

    if (app.ios_url) {
      links.push(`<a href="${app.ios_url}" target="_blank" rel="noopener noreferrer" class="app-link app-link-ios" title="App Store">üçé iOS</a>`);
    }

    if (app.android_url) {
      links.push(`<a href="${app.android_url}" target="_blank" rel="noopener noreferrer" class="app-link app-link-android" title="Google Play">ü§ñ Android</a>`);
    }

    if (app.web_url) {
      links.push(`<a href="${app.web_url}" target="_blank" rel="noopener noreferrer" class="app-link app-link-web" title="Web">üåê Web</a>`);
    }

    return links.length > 0 ? `<div class="app-links">${links.join('')}</div>` : '';
  }

  // Î∂ÄÎìúÎü¨Ïö¥ Ïä§ÌÅ¨Î°§ÎßÅ ÏÑ§Ï†ï
  setupSmoothScrolling() {
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
      anchor.addEventListener('click', function (e) {
        e.preventDefault();
        const target = document.querySelector(this.getAttribute('href'));
        if (target) {
          target.scrollIntoView({
            behavior: 'smooth',
            block: 'start'
          });
        }
      });
    });
  }

  // Ïä§ÌÅ¨Î°§ Ïï†ÎãàÎ©îÏù¥ÏÖò ÏÑ§Ï†ï
  setupAnimations() {
    const observerOptions = {
      threshold: 0.1,
      rootMargin: '0px 0px -50px 0px'
    };

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.classList.add('visible');
        }
      });
    }, observerOptions);

    // Ïï†ÎãàÎ©îÏù¥ÏÖò ÎåÄÏÉÅ ÏöîÏÜåÎì§ Í¥ÄÏ∞∞
    document.querySelectorAll('.fade-in').forEach(el => {
      observer.observe(el);
    });
  }

  // ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•ò Ïãú Í∏∞Î≥∏ Ïï± Ï†ïÎ≥¥ ÌëúÏãú
  showDefaultApps() {
    const defaultApps = [
      {
        id: '1',
        name: 'Î∂ÅÎû©',
        description: 'ÎèÖÏÑú Í¥ÄÎ¶¨ÏôÄ Í∏∞Î°ùÏùÑ ÏúÑÌïú Ïä§ÎßàÌä∏Ìïú Ïï±',
        icon_url: null,
        ios_url: null,
        android_url: null,
        web_url: null,
        target: 'books',
        platforms: ['ios', 'android'],
        sort_order: 0,
        is_active: true
      },
      {
        id: '2',
        name: 'Î£®Ìã∞',
        description: 'ÏÉùÌôú ÏäµÍ¥Ä Í∞úÏÑ†ÏúºÎ°ú Í±¥Í∞ïÌïòÍ≤å',
        icon_url: null,
        ios_url: null,
        android_url: null,
        web_url: null,
        target: 'rooty',
        platforms: ['ios', 'android'],
        sort_order: 1,
        is_active: true
      }
    ];

    console.log('Showing default apps:', defaultApps);
    this.renderApps(defaultApps);
    document.getElementById('apps-loading').classList.add('hidden');
    document.getElementById('apps-content').classList.remove('hidden');
  }

  // Í≥ÑÏ†ï ÏÇ≠Ï†ú Ìèº ÏÑ§Ï†ï
  setupAccountDeletion() {
    console.log('setupAccountDeletion called');
    const deletionForm = document.getElementById('deletion-form');
    const confirmCheckbox = document.getElementById('confirm-deletion');
    const submitButton = document.getElementById('submit-button');

    console.log('Elements found:', {
      deletionForm: !!deletionForm,
      confirmCheckbox: !!confirmCheckbox,
      submitButton: !!submitButton
    });

    if (!deletionForm || !confirmCheckbox || !submitButton) {
      console.log('Some elements not found, exiting setup');
      return; // Í≥ÑÏ†ï ÏÇ≠Ï†ú ÌéòÏù¥ÏßÄÍ∞Ä ÏïÑÎãàÎ©¥ Î¶¨ÌÑ¥
    }

    console.log('Setting up account deletion form');

    // Ï≤¥ÌÅ¨Î∞ïÏä§ ÏÉÅÌÉúÏóê Îî∞Îùº Î≤ÑÌäº ÌôúÏÑ±Ìôî/ÎπÑÌôúÏÑ±Ìôî
    confirmCheckbox.addEventListener('change', () => {
      console.log('Checkbox changed. Checked:', confirmCheckbox.checked);
      submitButton.disabled = !confirmCheckbox.checked;
      console.log('Button disabled:', submitButton.disabled);
    });

    // Ìèº Ï†úÏ∂ú Ï≤òÎ¶¨
    deletionForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!confirmCheckbox.checked) {
        alert('Í≥ÑÏ†ï ÏÇ≠Ï†úÏóê ÎèôÏùòÌï¥Ï£ºÏÑ∏Ïöî.');
        return;
      }

      const formData = new FormData(deletionForm);
      const email = formData.get('email');
      const reason = formData.get('reason') || '';

      // Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî Î∞è Î°úÎî© ÏÉÅÌÉú
      submitButton.disabled = true;
      submitButton.innerHTML = `
        <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        ÏöîÏ≤≠ Ï≤òÎ¶¨ Ï§ë...
      `;

      try {
        // Í≥ÑÏ†ï ÏÇ≠Ï†ú Ïù¥Î©îÏùº Ï†ÑÏÜ° (ÏÉàÎ°ú Íµ¨ÌòÑÎêú Edge Function ÏÇ¨Ïö©)
        const response = await this.sendAccountDeletionEmail(email, reason);

        if (response.success) {
          this.showFormMessage('success', `${email}Î°ú Í≥ÑÏ†ï ÏÇ≠Ï†ú ÌôïÏù∏ Ïù¥Î©îÏùºÏùÑ Î∞úÏÜ°ÌñàÏäµÎãàÎã§. Ïù¥Î©îÏùºÏùÑ ÌôïÏù∏ÌïòÏãúÍ≥† ÏÇ≠Ï†úÎ•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.`);
          deletionForm.reset();
        } else {
          throw new Error(response.error || 'ÏöîÏ≤≠ Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
        }
      } catch (error) {
        console.error('Account deletion request failed:', error);
        this.showFormMessage('error', 'ÏöîÏ≤≠ Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. danny@minorlab.comÏúºÎ°ú ÏßÅÏ†ë Ïó∞ÎùΩÌï¥Ï£ºÏÑ∏Ïöî.');
      } finally {
        // Î≤ÑÌäº ÏÉÅÌÉú Î≥µÏõê
        submitButton.disabled = false;
        submitButton.innerHTML = `
          <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 002 2z"></path>
          </svg>
          Í≥ÑÏ†ï ÏÇ≠Ï†ú ÏöîÏ≤≠ÌïòÍ∏∞
        `;
      }
    });
  }

  // Í≥ÑÏ†ï ÏÇ≠Ï†ú Ïù¥Î©îÏùº Ï†ÑÏÜ° (ÏÉàÎ°ú Íµ¨ÌòÑÎêú Edge Function ÏÇ¨Ïö©)
  async sendAccountDeletionEmail(email, reason) {
    try {
      const response = await fetch(`${this.SUPABASE_URL}/functions/v1/resend-email`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${this.SUPABASE_ANON_KEY}`
        },
        body: JSON.stringify({
          to: email,
          subject: 'BookLab Í≥ÑÏ†ï ÏÇ≠Ï†ú ÏöîÏ≤≠',
          html: `
            <h2>BookLab Í≥ÑÏ†ï ÏÇ≠Ï†ú ÏöîÏ≤≠</h2>
            <p>ÏïàÎÖïÌïòÏÑ∏Ïöî,</p>
            <p>BookLab Í≥ÑÏ†ï ÏÇ≠Ï†ú ÏöîÏ≤≠ÏùÑ Î∞õÏïòÏäµÎãàÎã§.</p>
            <p><strong>Í≥ÑÏ†ï Ïù¥Î©îÏùº:</strong> ${email}</p>
            ${reason ? `<p><strong>ÏÇ≠Ï†ú ÏÇ¨Ïú†:</strong> ${reason}</p>` : ''}
            <p>Í≥ÑÏ†ï ÏÇ≠Ï†úÎ•º ÌôïÏ†ïÌïòÏãúÎ†§Î©¥ ÏïÑÎûò ÎßÅÌÅ¨Î•º ÌÅ¥Î¶≠Ìï¥Ï£ºÏÑ∏Ïöî:</p>
            <p><a href="mailto:danny@minorlab.com?subject=BookLab Í≥ÑÏ†ï ÏÇ≠Ï†ú ÌôïÏù∏&body=Í≥ÑÏ†ï Ïù¥Î©îÏùº: ${encodeURIComponent(email)}%0A%0AÏúÑ Í≥ÑÏ†ïÏùò ÏÇ≠Ï†úÎ•º ÌôïÏù∏Ìï©ÎãàÎã§." style="background: #dc2626; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px;">Í≥ÑÏ†ï ÏÇ≠Ï†ú ÌôïÏù∏</a></p>
            <p>ÎòêÎäî danny@minorlab.comÏúºÎ°ú ÏßÅÏ†ë Ïó∞ÎùΩÌï¥Ï£ºÏÑ∏Ïöî.</p>
            <p>Í∞êÏÇ¨Ìï©ÎãàÎã§.<br>MinorLab ÌåÄ</p>
          `
        })
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || `HTTP ${response.status}`);
      }

      return await response.json();
    } catch (error) {
      console.error('Failed to send deletion email:', error);
      return { success: false, error: error.message };
    }
  }

  // Ìèº Î©îÏãúÏßÄ ÌëúÏãú
  showFormMessage(type, message) {
    const messageEl = document.getElementById('form-message');
    if (!messageEl) return;

    messageEl.className = `mt-4 p-4 rounded-lg ${type === 'success' ? 'bg-green-50 border border-green-200 text-green-800' : 'bg-red-50 border border-red-200 text-red-800'}`;
    messageEl.innerHTML = `
      <div class="flex">
        <div class="flex-shrink-0">
          ${type === 'success'
            ? '<svg class="h-5 w-5 text-green-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>'
            : '<svg class="h-5 w-5 text-red-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>'
          }
        </div>
        <div class="ml-3">
          <p class="text-sm font-medium">${type === 'success' ? 'ÏöîÏ≤≠Ïù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï†ÑÏÜ°ÎêòÏóàÏäµÎãàÎã§' : 'ÏöîÏ≤≠ Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§'}</p>
          <p class="mt-1 text-sm">${message}</p>
        </div>
      </div>
    `;
    messageEl.classList.remove('hidden');

    // ÏÑ±Í≥µ Î©îÏãúÏßÄÎäî 5Ï¥à ÌõÑ ÏûêÎèôÏúºÎ°ú Ïà®ÍπÄ
    if (type === 'success') {
      setTimeout(() => {
        messageEl.classList.add('hidden');
      }, 5000);
    }
  }
}

// DOM Î°úÎìú ÏôÑÎ£å Ïãú Ï¥àÍ∏∞Ìôî
document.addEventListener('DOMContentLoaded', () => {
  new MinorLabSite();
});

// Ï†ïÏ±Ö ÌéòÏù¥ÏßÄÏö© Ìï®ÏàòÎì§ (Ï†ÑÏó≠)
window.MinorLabAPI = {
  // Ï†ïÏ±Ö Î°úÎìú
  async loadPolicy(type) {
    const site = new MinorLabSite();
    try {
      const policies = await site.apiCall(`/policies?type=eq.${type}&is_active=eq.true&order=version.desc&limit=1`);
      return policies && policies.length > 0 ? policies[0] : null;
    } catch (error) {
      console.error(`Failed to load ${type} policy:`, error);
      return null;
    }
  },

  // ÎßàÌÅ¨Îã§Ïö¥ÏùÑ HTMLÎ°ú Î≥ÄÌôò
  convertMarkdownToHtml(markdown) {
    return markdown
      // Ìó§Îî©
      .replace(/^### (.*$)/gm, '<h3>$1</h3>')
      .replace(/^## (.*$)/gm, '<h2>$1</h2>')
      .replace(/^# (.*$)/gm, '<h1>$1</h1>')
      // ÍµµÏùÄ Í∏ÄÏî®
      .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
      // Í∏∞Ïö∏ÏûÑ
      .replace(/\*(.*?)\*/g, '<em>$1</em>')
      // ÎßÅÌÅ¨
      .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>')
      // Î™©Î°ù
      .replace(/^\- (.*$)/gm, '<li>$1</li>')
      .replace(/(<li>.*<\/li>\s*)+/gs, '<ul>$&</ul>')
      // Îã®ÎùΩ
      .replace(/\n\n/g, '</p><p>')
      .replace(/^(?![<h123ul])/gm, '<p>')
      .replace(/(?<![>])$/gm, '</p>')
      // Ï†ïÎ¶¨
      .replace(/<p><\/p>/g, '')
      .replace(/<p>(<[h123ul])/g, '$1')
      .replace(/(<\/[h123ul]>)<\/p>/g, '$1');
  }
};